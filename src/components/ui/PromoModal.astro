---
// PromoModal.astro
---

<div id="promo-modal" class="promo-modal-overlay" style="display: none;">
    <div class="promo-modal-content">
        <div class="promo-modal-inner"></div>
        <button
            id="close-promo"
            class="close-button"
            aria-label="Fechar promoção"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                ><line x1="18" y1="6" x2="6" y2="18"></line><line
                    x1="6"
                    y1="6"
                    x2="18"
                    y2="18"></line></svg
            >
        </button>

        <div class="promo-badge">OFERTA LIMITADA</div>

        <h2 class="promo-title">25% OFF</h2>
        <p class="promo-subtitle">EM QUALQUER PLANO</p>

        <div class="promo-message">
            Garanta seu site profissional com a melhor tecnologia do mercado por
            um preço exclusivo.
        </div>

        <div class="countdown-container">
            <div class="countdown-item">
                <span id="days" class="countdown-value">00</span>
                <span class="countdown-label">Dias</span>
            </div>
            <div class="countdown-item">
                <span id="hours" class="countdown-value">00</span>
                <span class="countdown-label">Horas</span>
            </div>
            <div class="countdown-item">
                <span id="minutes" class="countdown-value">00</span>
                <span class="countdown-label">Min</span>
            </div>
            <div class="countdown-item">
                <span id="seconds" class="countdown-value">00</span>
                <span class="countdown-label">Seg</span>
            </div>
        </div>

        <a href="/planos" class="promo-cta">
            APROVEITAR AGORA
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                ><line x1="5" y1="12" x2="19" y2="12"></line><polyline
                    points="12 5 19 12 12 19"></polyline></svg
            >
        </a>

        <p class="promo-footer">Válido somente até 14/02/2026 às 17:00H</p>
    </div>
</div>

<style>
    .promo-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
        z-index: 10000;
        display: flex;
        align-items: center; /* Centralizado em todas as telas */
        justify-content: center;
        padding: 20px;
        opacity: 0;
    }

    .promo-modal-content {
        background: linear-gradient(135deg, #0f0f0f 0%, #050505 100%);
        border: 2px solid #8a1c26;
        border-radius: 20px;
        width: 100%;
        max-width: 400px;
        padding: 45px 25px 30px;
        position: relative;
        text-align: center;
        box-shadow:
            0 25px 60px -12px rgba(0, 0, 0, 0.9),
            0 0 25px rgba(138, 28, 38, 0.5);
        /* Removi o overflow: hidden para o botão de fechar aparecer fora */
    }

    /* Recriei o overflow: hidden em um elemento interno para manter os efeitos de brilho */
    .promo-modal-inner {
        position: absolute;
        inset: -2px; /* Cobrir a borda ou ficar logo abaixo */
        border-radius: 20px;
        overflow: hidden;
        z-index: 0;
        pointer-events: none;
    }

    .promo-modal-content::after {
        display: none; /* Vou mover para o .promo-modal-inner */
    }

    .promo-modal-inner::after {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
            90deg,
            transparent,
            rgba(255, 255, 255, 0.07),
            transparent
        );
        animation: shine 2.5s infinite;
        z-index: 1;
    }

    @keyframes shine {
        0% {
            left: -100%;
        }
        20% {
            left: 100%;
        }
        100% {
            left: 100%;
        }
    }

    .promo-modal-inner::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
            circle,
            rgba(138, 28, 38, 0.2) 0%,
            transparent 70%
        );
        animation: rotateBg 20s linear infinite;
        z-index: 0;
    }

    @keyframes rotateBg {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }

    .promo-modal-content > *:not(.promo-modal-inner) {
        position: relative;
        z-index: 1;
    }

    .close-button {
        position: absolute;
        top: -20px;
        right: 0;
        transform: translate(
            -50%,
            -50%
        ); /* Centralização matemática perfeita na quina */
        background: #8a1c26;
        border: 2px solid white;
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 20;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6);
    }

    .close-button svg {
        width: 18px;
        height: 18px;
    }

    .close-button:hover {
        background: #a1212d;
        transform: translate(-50%, -50%) rotate(180deg) scale(1.1);
        border-color: white;
    }

    .promo-badge {
        background: linear-gradient(90deg, #8a1c26, #3b0a0f);
        color: white;
        display: inline-block;
        padding: 6px 18px;
        border-radius: 100px;
        font-size: 0.75rem;
        font-weight: 800;
        letter-spacing: 1.5px;
        margin-bottom: 20px;
        animation: pulse 2s infinite;
        box-shadow: 0 4px 12px rgba(138, 28, 38, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    @keyframes pulse {
        0% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(138, 28, 38, 0.6);
        }
        70% {
            transform: scale(1.03);
            box-shadow: 0 0 0 10px rgba(138, 28, 38, 0);
        }
        100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(138, 28, 38, 0);
        }
    }

    .promo-title {
        font-family: "Outfit", sans-serif;
        font-size: 3.8rem; /* Reduzi mais para caber melhor no novo tamanho */
        font-weight: 900;
        background: linear-gradient(to bottom, #ffffff 40%, #c42d38);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin: 0;
        line-height: 0.85;
        letter-spacing: -2px;
        filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.5));
    }

    .promo-subtitle {
        font-size: 1.3rem;
        font-weight: 800;
        color: #fff;
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.9;
    }

    .promo-message {
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.85rem;
        line-height: 1.3;
        margin-bottom: 25px;
        max-width: 280px;
        margin-left: auto;
        margin-right: auto;
    }

    .countdown-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin-bottom: 30px;
    }

    .countdown-item {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 12px 4px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .countdown-value {
        font-family: "Outfit", sans-serif;
        font-size: 1.5rem; /* Reduzi de 1.8rem */
        font-weight: 800;
        color: #8a1c26;
        line-height: 1;
    }

    .countdown-label {
        font-size: 0.6rem;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.4);
        letter-spacing: 0.5px;
        margin-top: 4px;
    }

    .promo-cta {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        background: linear-gradient(135deg, #8a1c26 0%, #a1212d 100%);
        color: white;
        text-decoration: none;
        padding: 16px 24px;
        border-radius: 14px;
        font-weight: 800;
        font-size: 1rem;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 8px 16px rgba(138, 28, 38, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .promo-cta:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 12px 24px rgba(138, 28, 38, 0.5);
        border-color: rgba(255, 255, 255, 0.3);
    }

    .promo-footer {
        margin-top: 20px;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.3);
    }

    @media (max-width: 480px) {
        .promo-modal-overlay {
            padding: 20px;
            align-items: center; /* Volta ao centro no mobile */
        }
        .promo-modal-content {
            padding: 40px 20px 25px;
            max-width: 88vw;
            border-radius: 20px;
        }
        .promo-title {
            font-size: 3.2rem;
        }
        .promo-subtitle {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        .promo-message {
            font-size: 0.8rem;
            margin-bottom: 15px;
            max-width: 220px;
        }
        .countdown-value {
            font-size: 1.25rem;
        }
        .close-button {
            top: -12px;
            right: -5px;
            transform: translate(-50%, -50%);
            width: 32px;
            height: 32px;
        }
        .close-button svg {
            width: 14px;
            height: 14px;
        }
    }
</style>

<script>
    import { gsap } from "gsap";

    function initPromoModal() {
        const modal = document.getElementById("promo-modal");
        const closeBtn = document.getElementById("close-promo");
        const targetDate = new Date("2026-02-14T17:00:00").getTime();

        // Verificar se é a página inicial e se já foi mostrado nesta sessão
        const isHomePage =
            window.location.pathname === "/" ||
            window.location.pathname === "/index.html";
        const hasBeenShown = sessionStorage.getItem("alpha_promo_shown");

        // Detectar se a página foi atualizada (Refresh/F5)
        const entries = performance.getEntriesByType("navigation");
        const isReload =
            entries.length > 0 && (entries[0] as any).type === "reload";

        // Só aparece na Home. Se já foi visto, só reaparece se for um Refresh (F5).
        if (!isHomePage || (hasBeenShown && !isReload)) return;

        function updateCountdown() {
            const now = new Date().getTime();
            const distance = targetDate - now;

            if (distance < 0) {
                if (modal) modal.style.display = "none";
                return false;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor(
                (distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60),
            );
            const minutes = Math.floor(
                (distance % (1000 * 60 * 60)) / (1000 * 60),
            );
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            const daysEl = document.getElementById("days");
            const hoursEl = document.getElementById("hours");
            const minsEl = document.getElementById("minutes");
            const secsEl = document.getElementById("seconds");

            if (daysEl) daysEl.innerText = days.toString().padStart(2, "0");
            if (hoursEl) hoursEl.innerText = hours.toString().padStart(2, "0");
            if (minsEl) minsEl.innerText = minutes.toString().padStart(2, "0");
            if (secsEl) secsEl.innerText = seconds.toString().padStart(2, "0");

            return true;
        }

        function showModal() {
            if (!modal) return;

            // Verifica se a promoção ainda é válida
            const isValid = updateCountdown();
            if (!isValid) return;

            // Marcar como mostrado para não exibir novamente nesta sessão
            sessionStorage.setItem("alpha_promo_shown", "true");

            modal.style.display = "flex";

            gsap.to(modal, {
                opacity: 1,
                duration: 0.5,
                ease: "power2.out",
            });

            gsap.from(".promo-modal-content", {
                scale: 0.8,
                y: 50,
                opacity: 0,
                duration: 0.8,
                ease: "back.out(1.7)",
                delay: 0.2,
            });

            setInterval(updateCountdown, 1000);
        }

        if (closeBtn && modal) {
            closeBtn.addEventListener("click", () => {
                gsap.to(modal, {
                    opacity: 0,
                    duration: 0.3,
                    onComplete: () => {
                        modal.style.display = "none";
                    },
                });
            });
        }

        // Mostrar após 3 segundos apenas se as condições forem atendidas
        setTimeout(showModal, 3000);
    }

    // Executar tanto no load quanto em navegações do Astro
    document.addEventListener("astro:page-load", initPromoModal);

    // Fallback se necessário
    if (document.readyState === "complete") {
        initPromoModal();
    } else {
        window.addEventListener("load", initPromoModal);
    }
</script>
