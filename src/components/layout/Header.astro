---
import { getSession } from "../../lib/auth";

const { request } = Astro;
let session = null;

try {
    session = await getSession(request);
} catch (error) {
    console.error(
        "[Header] Auth error:",
        error instanceof Error ? error.message : String(error),
    );
}

const currentPath = Astro.url.pathname;
const isDashboard = currentPath === "/dashboard" || currentPath === "/perfil";
---

<header id="main-header">
    <div class="container header-container">
        <!-- LEFT: Logo -->
        <a href="/" class="logo-link">
            <img
                src="/assets/logoText.svg"
                alt="Alpha Code Logo"
                class="nav-logo"
                width="150"
                height="50"
            />
        </a>

        <!-- CENTER: Desktop Navigation Links -->
        <nav class="desktop-nav">
            <ul>
                <li><a href="/#services">Serviços</a></li>
                <li><a href="/#projects">Projetos</a></li>
                <li><a href="/#testimonials">Depoimentos</a></li>
                <li><a href="/planos">Planos</a></li>
                <li><a href="/pedido?plan=manutencao">Manutenção</a></li>
                <li><a href="/about">Sobre</a></li>
            </ul>
        </nav>

        <!-- RIGHT: Actions (Login/Profile + Contact) -->
        <div class="header-actions">
            <!-- Desktop Action Group -->
            <div class="action-group desktop-only">
                {
                    session ? (
                        <a
                            href="/dashboard"
                            class={`profile-nav-btn ${isDashboard ? "active-dash active" : ""}`}
                            id="desktop-profile-trigger"
                        >
                            <span class="profile-text-node">Perfil</span>
                            <div class="profile-avatar-node">
                                {session.user?.image ? (
                                    <img
                                        src={session.user.image}
                                        alt="Avatar"
                                    />
                                ) : (
                                    <div class="avatar-letter">
                                        {session.user?.name?.charAt(0) || "U"}
                                    </div>
                                )}
                            </div>
                        </a>
                    ) : (
                        <a href="/login" class="btn-login-nav">
                            Login
                        </a>
                    )
                }
                <a
                    href="https://wa.me/5521999064502"
                    target="_blank"
                    class="btn btn-primary contact-btn"
                >
                    CONTATO
                </a>
            </div>

            <!-- Mobile Only Toggle -->
            <button
                id="mobile-menu-btn"
                aria-label="Menu"
                class="mobile-only menu-pill"
            >
                <div class="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </button>
        </div>
    </div>

    <!-- Mobile Menu Sidebar -->
    <div class="mobile-menu">
        <div class="mobile-menu-overlay" id="menu-overlay"></div>
        <div class="mobile-menu-inner">
            <!-- Header -->
            <div class="menu-header">
                <img
                    src="/assets/logoText.svg"
                    alt="Alpha Code"
                    class="menu-logo"
                    width="120"
                />
                <button
                    id="close-menu-btn"
                    class="close-icon-btn"
                    aria-label="Fechar Menu"
                >
                    <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        ><line x1="18" y1="6" x2="6" y2="18"></line><line
                            x1="6"
                            y1="6"
                            x2="18"
                            y2="18"></line></svg
                    >
                </button>
            </div>

            <!-- Content Area -->
            <div class="menu-content">
                <!-- Search Bar -->
                <div class="menu-search">
                    <div class="search-box">
                        <svg
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            ><circle cx="11" cy="11" r="8"></circle><line
                                x1="21"
                                y1="21"
                                x2="16.65"
                                y2="16.65"></line></svg
                        >
                        <input type="text" placeholder="Pesquisar..." />
                        <span class="search-key">⌘ F</span>
                    </div>
                </div>

                <!-- Main Navigation -->
                <nav class="menu-nav-section">
                    <ul>
                        <li class={currentPath === "/" ? "active" : ""}>
                            <a href="/">
                                <svg
                                    width="18"
                                    height="18"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><path
                                        d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"
                                    ></path><polyline
                                        points="9 22 9 12 15 12 15 22"
                                    ></polyline></svg
                                >
                                Início
                            </a>
                        </li>
                        <li>
                            <a href="/#services">
                                <svg
                                    width="18"
                                    height="18"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><rect
                                        x="2"
                                        y="3"
                                        width="20"
                                        height="14"
                                        rx="2"
                                        ry="2"></rect><line
                                        x1="8"
                                        y1="21"
                                        x2="16"
                                        y2="21"></line><line
                                        x1="12"
                                        y1="17"
                                        x2="12"
                                        y2="21"></line></svg
                                >
                                Serviços
                            </a>
                        </li>
                        <li>
                            <a href="/#projects">
                                <svg
                                    width="18"
                                    height="18"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><path
                                        d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"
                                    ></path></svg
                                >
                                Projetos
                            </a>
                        </li>
                        <li>
                            <a href="/#testimonials">
                                <svg
                                    width="18"
                                    height="18"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><path
                                        d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                                    ></path></svg
                                >
                                Depoimentos
                            </a>
                        </li>
                    </ul>
                </nav>

                <div class="menu-divider-text">OUTROS</div>

                <nav class="menu-nav-section">
                    <ul>
                        <li>
                            <a href="/planos">
                                <svg
                                    width="18"
                                    height="18"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><path
                                        d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"
                                    ></path></svg
                                >
                                Planos
                            </a>
                        </li>
                        <li>
                            <a href="/pedido?plan=manutencao">
                                <svg
                                    width="18"
                                    height="18"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><path
                                        d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"
                                    ></path></svg
                                >
                                Manutenção
                            </a>
                        </li>
                        <li>
                            <a href="/about">
                                <svg
                                    width="18"
                                    height="18"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><circle cx="12" cy="12" r="10"
                                    ></circle><line
                                        x1="12"
                                        y1="16"
                                        x2="12"
                                        y2="12"></line><line
                                        x1="12"
                                        y1="8"
                                        x2="12.01"
                                        y2="8"></line></svg
                                >
                                Sobre
                            </a>
                        </li>
                        <li>
                            <a
                                href="https://wa.me/5521999064502"
                                class="whatsapp-text"
                            >
                                <svg
                                    width="18"
                                    height="18"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><path
                                        d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
                                    ></path></svg
                                >
                                Suporte
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>

            <!-- Footer Profile -->
            <div class="menu-footer">
                {
                    session ? (
                        <div class="user-profile-bar">
                            <div class="user-avatar">
                                {session.user?.image ? (
                                    <img
                                        src={session.user.image}
                                        alt={session.user.name}
                                    />
                                ) : (
                                    <div class="avatar-init">
                                        {session.user?.name?.charAt(0) || "U"}
                                    </div>
                                )}
                            </div>
                            <div class="user-info">
                                <span class="user-name">
                                    {session.user?.name}
                                </span>
                                <span class="user-email">
                                    {session.user?.email}
                                </span>
                            </div>
                            <div class="user-actions">
                                <svg
                                    width="18"
                                    height="18"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                >
                                    <polyline points="18 15 12 9 6 15" />
                                </svg>
                            </div>
                        </div>
                    ) : (
                        <a href="/login" class="login-footer-btn">
                            <svg
                                width="18"
                                height="18"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            >
                                <>
                                    <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4" />
                                    <polyline points="10 17 15 12 10 7" />
                                    <line x1="15" y1="12" x2="3" y2="12" />
                                </>
                            </svg>
                            Acessar Conta
                        </a>
                    )
                }
            </div>
        </div>
    </div>
</header>

<script>
    const mobileMenuBtn = document.getElementById("mobile-menu-btn");
    const closeMenuBtn = document.getElementById("close-menu-btn");
    const menuOverlay = document.getElementById("menu-overlay");
    const mobileMenu = document.querySelector(".mobile-menu");
    const mobileLinks = document.querySelectorAll(".mobile-menu a");

    const toggleMenu = (open: boolean) => {
        if (!mobileMenu || !mobileMenuBtn) return;
        if (open) {
            mobileMenu.classList.add("open");
            mobileMenuBtn.classList.add("active");
            document.body.style.overflow = "hidden";
        } else {
            mobileMenu.classList.remove("open");
            mobileMenuBtn.classList.remove("active");
            document.body.style.overflow = "";
        }
    };

    if (mobileMenuBtn)
        mobileMenuBtn.addEventListener("click", () => toggleMenu(true));
    if (closeMenuBtn)
        closeMenuBtn.addEventListener("click", () => toggleMenu(false));
    if (menuOverlay)
        menuOverlay.addEventListener("click", () => toggleMenu(false));
    if (mobileLinks) {
        mobileLinks.forEach((link) => {
            link.addEventListener("click", () => toggleMenu(false));
        });
    }

    // Profile Expansion Logic
    const profileBtn = document.getElementById("desktop-profile-trigger");
    if (profileBtn) {
        profileBtn.addEventListener("click", (e) => {
            const link = profileBtn.getAttribute("href");
            if (link && !profileBtn.classList.contains("active-dash")) {
                e.preventDefault();
                profileBtn.classList.add("expanded");
                setTimeout(() => {
                    window.location.href = link;
                }, 400);
            }
        });
    }
</script>

<style>
    /* Header Container Fluidity */
    #main-header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background-color: rgba(2, 2, 2, 0.9);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        z-index: 1000;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        padding: 12px 0;
    }

    .header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100% !important;
        max-width: 100% !important;
        padding: 0 40px; /* Fixed symmetrical padding */
        height: 60px;
    }

    /* LEFT: Logo */
    .logo-link {
        flex-shrink: 0;
    }
    .nav-logo {
        height: 42px;
        width: auto;
    }

    /* CENTER: Desktop Links */
    .desktop-nav {
        flex-grow: 1;
        display: flex;
        justify-content: center;
    }
    .desktop-nav ul {
        display: flex;
        gap: 1.5rem;
        list-style: none;
        margin: 0;
        padding: 0;
    }
    .desktop-nav a {
        color: var(--color-text-secondary);
        font-weight: 500;
        font-size: 0.9rem;
        transition: color 0.3s ease;
        white-space: nowrap;
    }
    .desktop-nav a:hover {
        color: white;
    }

    /* RIGHT: Actions */
    .header-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-shrink: 0;
    }

    .action-group {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    /* Login & Contact Buttons */
    .btn-login-nav {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 8px 24px;
        border-radius: 50px;
        font-size: 0.85rem;
        font-weight: 600;
        color: white;
        height: 44px;
        display: inline-flex;
        align-items: center;
        text-decoration: none;
        transition: all 0.3s ease;
    }
    .btn-login-nav:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-2px);
    }

    .contact-btn {
        padding: 0 1.5rem !important;
        height: 44px;
        display: flex;
        align-items: center;
        font-size: 0.75rem !important;
        letter-spacing: 1px;
        font-weight: 800 !important;
    }

    /* Profile Capsule */
    .profile-nav-btn {
        display: flex;
        align-items: center;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 50px;
        width: 44px;
        height: 44px;
        overflow: hidden;
        transition: all 0.4s ease;
        justify-content: center;
    }
    .profile-nav-btn.active-dash,
    .profile-nav-btn.expanded {
        width: 125px;
        background: var(--color-primary);
        padding: 0 4px 0 14px;
        justify-content: space-between;
        border-color: var(--color-primary);
    }
    .profile-avatar-node {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        overflow: hidden;
    }
    .profile-avatar-node img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .profile-text-node {
        max-width: 0;
        opacity: 0;
        visibility: hidden;
        transition: 0.3s;
        color: white;
        font-weight: 700;
        font-size: 0.85rem;
    }
    .profile-nav-btn.active-dash .profile-text-node,
    .profile-nav-btn.expanded .profile-text-node {
        max-width: 70px;
        opacity: 1;
        visibility: visible;
    }

    /* Mobile Menu BTN */
    .menu-pill {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 50px;
        padding: 12px;
        cursor: pointer;
    }
    .hamburger {
        display: flex;
        flex-direction: column;
        gap: 4px;
        width: 18px;
    }
    .hamburger span {
        display: block;
        width: 100%;
        height: 2px;
        background-color: white;
        border-radius: 2px;
    }

    /* Mobile Menu Sidebar */
    .mobile-menu {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 2000;
        visibility: hidden;
        transition: visibility 0.4s;
    }
    .mobile-menu.open {
        visibility: visible;
    }

    .mobile-menu-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        opacity: 0;
        transition: opacity 0.4s ease;
    }
    .mobile-menu.open .mobile-menu-overlay {
        opacity: 1;
    }

    .mobile-menu-inner {
        position: absolute;
        top: 0;
        right: 0;
        width: 85%;
        max-width: 320px;
        height: 100%;
        background: #0d0d0d;
        border-left: 1px solid rgba(255, 255, 255, 0.08);
        display: flex;
        flex-direction: column;
        transform: translateX(100%);
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        padding: 0;
        overflow: hidden;
    }
    .mobile-menu.open .mobile-menu-inner {
        transform: translateX(0);
    }

    /* Menu Header */
    .menu-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px 20px;
    }
    .menu-logo {
        height: 32px;
        width: auto;
    }
    .close-icon-btn {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #888;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    /* Menu Content Scrollable */
    .menu-content {
        flex: 1;
        overflow-y: auto;
        padding: 0 16px 24px;
    }

    /* Search Box */
    .menu-search {
        margin-bottom: 24px;
        padding: 0 4px;
    }
    .search-box {
        display: flex;
        align-items: center;
        background: #161616;
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 10px 14px;
        gap: 12px;
        color: #666;
    }
    .search-box input {
        background: none;
        border: none;
        color: white;
        font-size: 0.9rem;
        width: 100%;
        outline: none;
    }
    .search-key {
        font-size: 0.7rem;
        background: #222;
        padding: 2px 6px;
        border-radius: 4px;
        border: 1px solid #333;
        color: #555;
        white-space: nowrap;
    }

    /* Nav Sections */
    .menu-nav-section {
        margin-bottom: 24px;
    }
    .menu-nav-section ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .menu-nav-section li {
        margin-bottom: 4px;
    }
    .menu-nav-section a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        color: #999;
        text-decoration: none;
        font-size: 0.95rem;
        font-weight: 500;
        border-radius: 10px;
        transition: all 0.2s ease;
    }
    .menu-nav-section li.active a,
    .menu-nav-section a:hover {
        background: rgba(255, 255, 255, 0.04);
        color: white;
    }
    .menu-nav-section li.active a {
        background: linear-gradient(
            -90deg,
            rgba(138, 28, 38, 0.15) 0%,
            transparent 100%
        );
        border-left: 2px solid var(--color-primary);
        color: white;
    }
    .menu-nav-section li.active a svg {
        color: var(--color-primary);
    }
    .whatsapp-text {
        color: #25d366 !important;
    }

    .menu-divider-text {
        font-size: 0.7rem;
        font-weight: 700;
        color: #444;
        letter-spacing: 1px;
        margin: 0 0 12px 12px;
    }

    /* Profile Footer */
    .menu-footer {
        padding: 16px;
        background: #0a0a0a;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    .user-profile-bar {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.02);
    }
    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        overflow: hidden;
        background: #222;
        flex-shrink: 0;
    }
    .user-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .avatar-init {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        background: var(--color-primary);
    }
    .user-info {
        flex: 1;
        min-width: 0;
    }
    .user-name {
        display: block;
        color: white;
        font-size: 0.85rem;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .user-email {
        display: block;
        color: #555;
        font-size: 0.75rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .user-actions {
        color: #444;
    }

    .login-footer-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        background: rgba(255, 255, 255, 0.05);
        color: white;
        padding: 12px;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 600;
        text-decoration: none;
        border: 1px solid rgba(255, 255, 255, 0.08);
    }

    /* Responsive */
    .desktop-only {
        display: flex;
    }
    .mobile-only {
        display: none;
    }

    @media (max-width: 1100px) {
        .header-container {
            padding: 0 40px;
        }
        .desktop-nav ul {
            gap: 1rem;
        }
    }

    @media (max-width: 968px) {
        .header-container {
            padding: 0 20px !important;
        }
        .logo-link img {
            width: 130px;
        }
        .desktop-nav {
            display: none;
        }
        .desktop-only {
            display: none;
        }
        .mobile-only {
            display: flex;
        }
    }
</style>
