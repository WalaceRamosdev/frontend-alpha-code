---
import Layout from "../layouts/BaseLayout.astro";
import { getSession } from "../lib/auth";

let session = null;
try {
    session = await getSession(Astro.request);
} catch (e) {
    console.error("Profile Auth Error:", e);
}

if (!session) {
    return Astro.redirect("/login");
}
export const prerender = false;
---

<Layout title="Meu Perfil | Alpha Code" showWhatsApp={false}>
    <div class="dashboard-wrapper">
        <div class="ambient-glow"></div>
        <div class="container dashboard-container">
            <header class="dashboard-header">
                <div class="welcome-text">
                    <a href="/dashboard" class="back-link"
                        >← Voltar para o Dashboard</a
                    >
                    <h1 class="user-name">Meu Perfil</h1>
                </div>
            </header>

            <div class="content-grid single-col">
                <section class="main-card">
                    <div class="profile-header">
                        <div class="avatar-container">
                            <div class="avatar-large" id="avatar-preview">
                                {
                                    session.user?.image ? (
                                        <img
                                            src={session.user.image}
                                            alt="Avatar"
                                        />
                                    ) : (
                                        session.user?.name?.charAt(0) || "U"
                                    )
                                }
                            </div>
                            <label
                                for="avatar-input"
                                class="edit-avatar-btn"
                                title="Alterar Foto"
                            >
                                <svg
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    ><path
                                        d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"
                                    ></path><circle cx="12" cy="13" r="4"
                                    ></circle></svg
                                >
                            </label>
                            <input
                                type="file"
                                id="avatar-input"
                                accept="image/*"
                                style="display: none;"
                            />
                        </div>
                        <div class="profile-info-top">
                            <h2 id="profile-name-display">
                                {session.user?.name || "Usuário"}
                            </h2>
                            <span>{session.user?.email}</span>
                        </div>
                    </div>

                    <form class="profile-form" id="profile-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Nome Completo</label>
                                <input
                                    type="text"
                                    id="input-name"
                                    value={session.user?.name}
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label>Email (Não editável)</label>
                                <input
                                    type="email"
                                    value={session.user?.email}
                                    disabled
                                />
                            </div>
                            <div class="form-group">
                                <label>Telefone</label>
                                <input
                                    type="text"
                                    id="input-phone"
                                    placeholder="(DD) 99999-9999"
                                    value={session.user?.phone || ""}
                                />
                            </div>
                            <div class="form-group">
                                <label>Empresa</label>
                                <input
                                    type="text"
                                    id="input-company"
                                    placeholder="Nome da sua empresa"
                                    value={session.user?.company || ""}
                                />
                            </div>
                        </div>

                        <div class="password-section">
                            <h3>Segurança</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Senha Atual</label>
                                    <input
                                        type="password"
                                        id="input-old-password"
                                        placeholder="••••••••"
                                    />
                                </div>
                                <div class="form-group">
                                    <label>Nova Senha</label>
                                    <input
                                        type="password"
                                        id="input-new-password"
                                        placeholder="Mínimo 6 caracteres"
                                    />
                                </div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button
                                type="submit"
                                class="btn-primary-small"
                                id="save-btn">Salvar Alterações</button
                            >
                        </div>
                    </form>
                </section>
            </div>
        </div>
    </div>

    <script>
        // Use type assertions and null checks to satisfy TypeScript
        const form = document.getElementById(
            "profile-form",
        ) as HTMLFormElement | null;
        const saveBtn = document.getElementById(
            "save-btn",
        ) as HTMLButtonElement | null;
        const avatarInput = document.getElementById(
            "avatar-input",
        ) as HTMLInputElement | null;
        const avatarPreview = document.getElementById(
            "avatar-preview",
        ) as HTMLElement | null;
        const nameDisplay = document.getElementById(
            "profile-name-display",
        ) as HTMLElement | null;

        let currentImageBase64: string | null = null;

        // Avatar Preview Logic
        if (avatarInput && avatarPreview) {
            avatarInput.addEventListener("change", (e: Event) => {
                const target = e.target as HTMLInputElement;
                const file = target.files ? target.files[0] : null;
                    if (file.size > 2 * 1024 * 1024) {
                        // 2MB limit
                        (window as any).showToast("A imagem deve ter no máximo 2MB.", "error");
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (
                        readerEvent: ProgressEvent<FileReader>,
                    ) => {
                        const base64 = readerEvent.target?.result as string;
                        currentImageBase64 = base64;
                        if (avatarPreview) {
                            avatarPreview.innerHTML = `<img src="${base64}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: inherit;" />`;
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Form Submit Logic
        if (form && saveBtn && nameDisplay) {
            form.addEventListener("submit", async (e: Event) => {
                e.preventDefault();
                const originalText = saveBtn.innerText;
                saveBtn.innerText = "Salvando...";
                saveBtn.disabled = true;

                const nameInput = document.getElementById(
                    "input-name",
                ) as HTMLInputElement | null;
                const phoneInput = document.getElementById(
                    "input-phone",
                ) as HTMLInputElement | null;
                const companyInput = document.getElementById(
                    "input-company",
                ) as HTMLInputElement | null;

                const name = nameInput ? nameInput.value : "";
                const phone = phoneInput ? phoneInput.value : "";
                const company = companyInput ? companyInput.value : "";

                try {
                    const res = await fetch("/api/user/update", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            name,
                            phone,
                            company,
                            image: currentImageBase64 || undefined,
                        }),
                    });

                    if (res.ok) {
                        if (nameDisplay) nameDisplay.innerText = name;
                        (window as any).showToast("Perfil atualizado com sucesso!");
                        
                        // Recarregar para atualizar o Header (server-side)
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        const data = await res.json();
                        (window as any).showToast(data.message || "Erro ao atualizar perfil.", "error");
                    }
                } catch (err) {
                    console.error(err);
                    (window as any).showToast("Erro ao conectar com o servidor.", "error");
                } finally {
                    if (saveBtn) {
                        saveBtn.innerText = originalText;
                        saveBtn.disabled = false;
                    }
                }
            });
        }
    </script>
</Layout>

<style>
    .dashboard-wrapper {
        min-height: 100vh;
        background-color: var(--color-bg-body);
        padding-top: 120px;
        position: relative;
    }
    .ambient-glow {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        height: 500px;
        background: radial-gradient(
            circle at top,
            rgba(138, 28, 38, 0.1),
            transparent 70%
        );
        pointer-events: none;
    }
    .dashboard-container {
        position: relative;
        z-index: 1;
    }
    .back-link {
        color: var(--color-text-muted);
        text-decoration: none;
        font-size: 0.9rem;
        display: block;
        margin-bottom: 0.5rem;
    }
    .back-link:hover {
        color: var(--color-primary);
    }
    .user-name {
        font-size: 2.5rem;
        font-weight: 800;
        color: white;
    }
    .main-card {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 24px;
        padding: 3rem;
        backdrop-filter: blur(10px);
    }
    .profile-header {
        display: flex;
        align-items: center;
        gap: 2rem;
        margin-bottom: 3rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    .avatar-container {
        position: relative;
    }
    .avatar-large {
        width: 100px;
        height: 100px;
        background: var(--color-primary);
        color: white;
        border-radius: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        font-weight: 800;
        box-shadow: 0 10px 30px rgba(138, 28, 38, 0.3);
        overflow: hidden;
    }
    .avatar-large img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .edit-avatar-btn {
        position: absolute;
        bottom: -5px;
        right: -5px;
        background: white;
        color: black;
        width: 32px;
        height: 32px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        transition: 0.3s;
    }
    .edit-avatar-btn:hover {
        transform: scale(1.1);
        background: var(--color-primary);
        color: white;
    }
    .profile-info-top h2 {
        color: white;
        margin: 0;
        font-size: 1.8rem;
    }
    .profile-info-top span {
        color: #777;
    }
    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }
    /* Mobile Optimization */
    @media (max-width: 600px) {
        .dashboard-wrapper {
            padding-top: 100px;
        }

        .user-name {
            font-size: 1.8rem;
            margin-bottom: 1rem;
        }

        .main-card {
            padding: 1.5rem;
            border-radius: 20px;
        }

        .profile-header {
            flex-direction: column;
            text-align: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .btn-primary-small {
            width: 100%;
            text-align: center;
        }
    }
    .password-section {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    .password-section h3 {
        color: white;
        margin-bottom: 1.5rem;
    }
    .form-group label {
        display: block;
        color: #888;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }
    .form-group input {
        width: 100%;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        color: white;
        padding: 1rem;
    }
    .form-group input:focus {
        outline: none;
        border-color: var(--color-primary);
        background: rgba(255, 255, 255, 0.08);
    }
    .form-group input:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .btn-primary-small {
        background: var(--color-primary);
        color: white;
        border: none;
        padding: 1rem 2.5rem;
        border-radius: 50px;
        font-weight: 700;
        cursor: pointer;
        margin-top: 2rem;
        transition: 0.3s;
    }
    .btn-primary-small:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(138, 28, 38, 0.4);
    }
    .single-col {
        max-width: 900px;
        margin: 0 auto;
    }
</style>
